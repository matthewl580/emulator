{
  "initCode": "// RPG Battle Init\nwindow._state = {\n  player: {\n    hp: 100,\n    maxHp: 100,\n    mp: 50,\n    maxMp: 50,\n    level: 1,\n    exp: 0,\n    nextLevel: 100,\n    skills: [\n      { name: 'Attack', mp: 0, power: 10 },\n      { name: 'Heal', mp: 10, power: 30 },\n      { name: 'Fireball', mp: 20, power: 35 },\n      { name: 'Lightning', mp: 30, power: 50 }\n    ]\n  },\n  enemy: {\n    name: 'Dragon',\n    hp: 200,\n    maxHp: 200,\n    skills: [\n      { name: 'Claw', power: 15 },\n      { name: 'Bite', power: 25 },\n      { name: 'Fire Breath', power: 40 }\n    ]\n  },\n  messages: [],\n  selectedSkill: 0,\n  turn: 'player',\n  animationFrame: 0,\n  gameOver: false\n};\n\n// Setup audio\ntry {\n  window._synth = new Tone.Synth().toDestination();\n  window._effects = {\n    select: () => window._synth.triggerAttackRelease('C4', '32n'),\n    attack: () => window._synth.triggerAttackRelease('G3', '16n'),\n    magic: () => window._synth.triggerAttackRelease(['C5', 'E5'], '8n'),\n    heal: () => window._synth.triggerAttackRelease(['E4', 'G4', 'C5'], '4n'),\n    victory: () => {\n      window._synth.triggerAttackRelease('C4', '8n', Tone.now());\n      window._synth.triggerAttackRelease('E4', '8n', Tone.now() + 0.1);\n      window._synth.triggerAttackRelease('G4', '8n', Tone.now() + 0.2);\n      window._synth.triggerAttackRelease('C5', '2n', Tone.now() + 0.3);\n    },\n    defeat: () => {\n      window._synth.triggerAttackRelease('C4', '8n', Tone.now());\n      window._synth.triggerAttackRelease('G3', '8n', Tone.now() + 0.1);\n      window._synth.triggerAttackRelease('C3', '2n', Tone.now() + 0.2);\n    }\n  };\n} catch (e) { console.warn('Tone unavailable', e); }",
  "updateCode": "// RPG Battle Update\n(function(){\n  const canvas = document.getElementById('game-canvas');\n  const ctx = window._ctx || canvas.getContext('2d');\n  const state = window._state;\n  if (!state || state.gameOver) return;\n\n  // Input handling\n  document.onkeydown = (e) => {\n    if (state.turn !== 'player' || state.gameOver) return;\n\n    switch(e.key) {\n      case 'ArrowUp':\n        state.selectedSkill = (state.selectedSkill - 1 + state.player.skills.length) % \n                             state.player.skills.length;\n        if (window._effects) window._effects.select();\n        break;\n      case 'ArrowDown':\n        state.selectedSkill = (state.selectedSkill + 1) % state.player.skills.length;\n        if (window._effects) window._effects.select();\n        break;\n      case ' ':\n      case 'Enter':\n        const skill = state.player.skills[state.selectedSkill];\n        if (state.player.mp >= skill.mp) {\n          state.player.mp -= skill.mp;\n          \n          // Apply skill effect\n          if (skill.name === 'Heal') {\n            state.player.hp = Math.min(state.player.maxHp, \n                                     state.player.hp + skill.power);\n            state.messages.push(`Player uses ${skill.name}! Healed ${skill.power} HP!`);\n            if (window._effects) window._effects.heal();\n          } else {\n            state.enemy.hp -= skill.power;\n            state.messages.push(\n              `Player uses ${skill.name}! Dealt ${skill.power} damage!`\n            );\n            if (window._effects) {\n              if (skill.mp > 0) window._effects.magic();\n              else window._effects.attack();\n            }\n          }\n          \n          state.turn = 'enemy';\n          state.animationFrame = 30; // Animation duration\n\n          // Check enemy defeat\n          if (state.enemy.hp <= 0) {\n            state.enemy.hp = 0;\n            state.gameOver = true;\n            state.messages.push('Victory! The dragon has been defeated!');\n            \n            // Level up\n            state.player.exp += 100;\n            if (state.player.exp >= state.player.nextLevel) {\n              state.player.level++;\n              state.player.exp -= state.player.nextLevel;\n              state.player.nextLevel *= 1.5;\n              state.player.maxHp += 20;\n              state.player.maxMp += 10;\n              state.player.hp = state.player.maxHp;\n              state.player.mp = state.player.maxMp;\n              state.messages.push('Level Up! HP and MP restored!');\n            }\n            \n            if (window._effects) window._effects.victory();\n          }\n        }\n        break;\n    }\n  };\n\n  // Enemy turn\n  if (state.turn === 'enemy' && state.animationFrame <= 0) {\n    const skill = state.enemy.skills[\n      Math.floor(Math.random() * state.enemy.skills.length)\n    ];\n    state.player.hp -= skill.power;\n    state.messages.push(\n      `Dragon uses ${skill.name}! Dealt ${skill.power} damage!`\n    );\n    if (window._effects) window._effects.attack();\n\n    // Check player defeat\n    if (state.player.hp <= 0) {\n      state.player.hp = 0;\n      state.gameOver = true;\n      state.messages.push('Game Over! You have been defeated...');\n      if (window._effects) window._effects.defeat();\n    }\n\n    state.turn = 'player';\n  }\n\n  // Update animation\n  if (state.animationFrame > 0) state.animationFrame--;\n\n  // Keep message log limited\n  if (state.messages.length > 4) state.messages.shift();\n\n  // Clear screen\n  ctx.fillStyle = '#000033';\n  ctx.fillRect(0, 0, canvas.width, canvas.height);\n\n  const scale = canvas.width / 64;\n\n  // Draw battle scene background\n  ctx.fillStyle = '#222244';\n  for (let i = 0; i < 10; i++) {\n    ctx.fillRect(\n      0,\n      canvas.height - i * 20,\n      canvas.width,\n      10\n    );\n  }\n\n  // Draw enemy\n  const enemyShake = state.turn === 'player' && state.animationFrame > 0 ? \n                    Math.random() * 4 - 2 : 0;\n  ctx.fillStyle = '#ff4444';\n  ctx.fillRect(\n    canvas.width/2 - 40 + enemyShake,\n    canvas.height/4 - 40,\n    80,\n    80\n  );\n\n  // Draw enemy HP bar\n  ctx.fillStyle = '#220000';\n  ctx.fillRect(canvas.width/2 - 50, canvas.height/4 + 50, 100, 10);\n  ctx.fillStyle = '#ff0000';\n  ctx.fillRect(\n    canvas.width/2 - 50,\n    canvas.height/4 + 50,\n    (state.enemy.hp / state.enemy.maxHp) * 100,\n    10\n  );\n\n  // Draw player status\n  const playerShake = state.turn === 'enemy' && state.animationFrame > 0 ?\n                     Math.random() * 4 - 2 : 0;\n  ctx.fillStyle = '#4444ff';\n  ctx.fillRect(40 + playerShake, canvas.height - 120, 40, 60);\n\n  // Draw player stats\n  ctx.fillStyle = '#ffffff';\n  ctx.font = '12px monospace';\n  ctx.fillText(`HP: ${state.player.hp}/${state.player.maxHp}`, 100, canvas.height - 100);\n  ctx.fillText(`MP: ${state.player.mp}/${state.player.maxMp}`, 100, canvas.height - 80);\n  ctx.fillText(`Lv: ${state.player.level}`, 100, canvas.height - 60);\n\n  // Draw skill menu\n  ctx.fillStyle = '#000066';\n  ctx.fillRect(canvas.width - 200, canvas.height - 150, 180, 130);\n\n  state.player.skills.forEach((skill, i) => {\n    if (i === state.selectedSkill) {\n      ctx.fillStyle = '#4444aa';\n      ctx.fillRect(\n        canvas.width - 195,\n        canvas.height - 140 + i * 30,\n        170,\n        25\n      );\n    }\n    ctx.fillStyle = state.player.mp >= skill.mp ? '#ffffff' : '#666666';\n    ctx.fillText(\n      `${skill.name} (${skill.mp} MP)`,\n      canvas.width - 180,\n      canvas.height - 120 + i * 30\n    );\n  });\n\n  // Draw message log\n  ctx.fillStyle = '#000066';\n  ctx.fillRect(10, 10, 300, 100);\n  ctx.fillStyle = '#ffffff';\n  state.messages.forEach((msg, i) => {\n    ctx.fillText(msg, 20, 30 + i * 20);\n  });\n\n  // Game over screen\n  if (state.gameOver) {\n    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';\n    ctx.fillRect(0, 0, canvas.width, canvas.height);\n    \n    ctx.fillStyle = '#ffffff';\n    ctx.font = '24px monospace';\n    ctx.fillText(\n      state.player.hp > 0 ? 'Victory!' : 'Game Over!',\n      canvas.width/4,\n      canvas.height/2\n    );\n  }\n})();",
  "displayMode": "1",
  "timestamp": "2025-11-04T00:00:00.000Z"
}